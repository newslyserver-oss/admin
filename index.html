<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ews.ly Feed (Web)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <style>
    :root{
      --bg:#0B0B0F;
      --surface:#0e0f14;
      --card:#111217;
      --border:#1b1c25;
      --text:#e8e8f0;
      --text-2:#b2b3bd;
      --text-3:#8a8b95;
      --primary:#8B5CF6;
      --btn-sec:#161721;
      --radius:16px;
      --maxw:520px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:var(--bg);color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    .app{
      min-height:100dvh; display:flex; flex-direction:column; align-items:center;
    }
    /* Header */
    .header{
      position:sticky; top:0; z-index:1000;
      width:100%; background:var(--bg);
      padding: max(env(safe-area-inset-top,0px),12px) 12px 8px 12px;
      display:flex; align-items:center; justify-content:space-between;
      border-bottom:1px solid var(--border);
    }
    .brand{
      display:flex; align-items:center; gap:8px;
    }
    .logo{
      width:32px; height:32px; border-radius:8px;
      background:linear-gradient(135deg,#8B5CF6,#5B21B6);
      display:grid; place-items:center; color:white; font-weight:900; font-size:14px;
    }
    .title{
      display:flex; align-items:baseline; gap:2px; letter-spacing:.3px;
      line-height:1;
    }
    .title .t1{font-size:22px; font-weight:800}
    .title .dot{color:var(--primary); font-size:26px; line-height:0}
    .title .t2{font-size:22px; font-weight:800}
    .actions{display:flex; align-items:center; gap:12px}
    .iconbtn{
      width:36px;height:36px;border-radius:10px;background:var(--btn-sec);
      display:grid;place-items:center;color:var(--text-2);cursor:pointer;
      border:1px solid var(--border);
      transition:transform .15s ease;
    }
    .iconbtn:active{transform:scale(.96)}

    /* Chips */
    .chips-wrap{
      width:100%; background:var(--bg);
      position:sticky; top: calc(56px + env(safe-area-inset-top,0px));
      z-index:900; border-bottom:1px solid var(--border);
    }
    .chips{
      display:flex; gap:8px; overflow:auto; padding:8px 10px; scrollbar-width:none;
      -ms-overflow-style:none;
    }
    .chips::-webkit-scrollbar{display:none}
    .chip{
      height:32px; padding:0 14px; border-radius:16px; font-size:13px; font-weight:600;
      display:inline-flex; align-items:center; white-space:nowrap; cursor:pointer;
      background:var(--surface); color:var(--text);
      border:1px solid var(--border);
      transition:background .15s ease, color .15s ease, border-color .15s ease;
    }
    .chip.active{
      background:var(--primary); color:white; border-color:transparent;
    }

    /* Card area */
    .content{
      flex:1; width:100%; display:flex; justify-content:center;
    }
    .stage{
      width:100%; max-width:var(--maxw);
      padding:10px 16px 18px 16px; display:flex; flex-direction:column; gap:8px;
    }
    .card{
      background:var(--card); border-radius:var(--radius);
      border:1px solid var(--border); overflow:hidden; position:relative;
      transform: translateY(0) scale(1);
      transition: transform .28s ease;
      will-change: transform;
      min-height: 68vh; display:flex; flex-direction:column;
    }
    .card.swiping{transition: none}
    .art{
      position:relative; width:100%;
      height: max(30vh, 220px);
      background:#0a0a0f; overflow:hidden;
    }
    .art img{
      width:100%; height:100%; object-fit:cover; display:block;
      background:#0a0a0f;
    }
    .pill{
      position:absolute; top:12px; left:12px;
      background:var(--primary); color:white;
      padding:6px 10px; border-radius:16px; font-size:12px; font-weight:700;
      text-transform:uppercase;
    }
    .body{
      flex:1; overflow:auto; padding:18px 18px 120px 18px;
      scrollbar-width:thin; scrollbar-color:var(--border) transparent;
    }
    .h1{
      font-size:21px; font-weight:800; line-height:1.35; margin:0 0 10px 0; color:var(--text);
    }
    .sum{
      font-size:15px; color:var(--text-2); line-height:1.45; margin:0 0 14px 0;
    }
    .meta{
      display:flex; align-items:center; justify-content:space-between; color:var(--text-3);
      font-size:12px; font-weight:600; gap:8px;
    }
    .footer-bar{
      position:absolute; left:16px; right:16px; bottom:12px; z-index:10;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .btn{
      height:44px; border-radius:10px; display:inline-flex; align-items:center; justify-content:center;
      padding:0 16px; cursor:pointer; border:0;
      font-weight:700; letter-spacing:.2px;
      transition: transform .1s ease, opacity .15s ease;
    }
    .btn:active{transform:translateY(1px)}
    .btn-primary{background:var(--primary); color:#fff}
    .fab{
      width:48px; height:48px; border-radius:50%; background:var(--btn-sec);
      border:1px solid var(--border); display:grid; place-items:center; cursor:pointer;
      color:var(--primary);
      box-shadow:0 6px 20px rgba(0,0,0,.25);
    }

    /* Share Sheet */
    .sheet-backdrop{
      position:fixed; inset:0; background:rgba(0,0,0,.45);
      display:none; align-items:center; justify-content:center; z-index:1200;
    }
    .sheet{ width:295px; background:var(--surface); border:1px solid var(--border);
      border-radius:22px; padding:24px; position:relative;
      box-shadow:0 6px 18px rgba(0,0,0,.35);
    }
    .sheet h3{margin:0 0 16px 0; text-align:center; font-size:18px}
    .x{
      position:absolute; top:10px; right:10px; width:30px; height:30px; border-radius:8px;
      background:var(--btn-sec); border:1px solid var(--border); display:grid; place-items:center; cursor:pointer; color:var(--text-2);
    }
    .share-row{display:flex; align-items:center; gap:12px; padding:12px 4px; border-bottom:1px solid var(--border); cursor:pointer}
    .share-row:last-child{border-bottom:0}

    /* Toast */
    .toast{
      position:fixed; top:14px; left:50%; transform:translateX(-50%);
      background:#000; color:#fff; padding:10px 14px; border-radius:8px; font-size:13px;
      display:none; z-index:1500;
    }

    /* Loading and empty */
    .center{
      width:100%; max-width:var(--maxw); padding:40px 20px; display:grid; place-items:center; color:var(--text-2);
    }
    .spinner{ width:28px; height:28px; border-radius:50%; border:3px solid var(--border); border-top-color:var(--primary); animation:spin 1s linear infinite }
    @keyframes spin{to{transform:rotate(360deg)}}

    /* Desktop: keep same phone-like width */
    @media (min-width: 768px){
      .stage{padding-top:16px}
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- Header -->
    <div class="header">
      <div class="brand">
        <div class="logo">N</div>
        <div class="title">
          <span class="t1">ews</span><span class="dot">.</span><span class="t2">ly</span>
        </div>
      </div>
      <div class="actions">
        <button class="iconbtn" id="refreshBtn" title="Refresh" aria-label="Refresh">
          &#8635;
        </button>
      </div>
    </div>

    <!-- Chips -->
    <div class="chips-wrap">
      <div class="chips" id="chips"></div>
    </div>

    <!-- Content -->
    <div class="content">
      <div class="stage">
        <div class="center" id="loader"><div class="spinner"></div></div>
        <div class="center" id="empty" style="display:none">No news available</div>

        <div class="card" id="card" style="display:none">
          <div class="art">
            <img id="artImg" alt="news cover" />
            <div class="pill" id="pill">GENERAL</div>
          </div>

          <div class="body" id="scrollBody">
            <h1 class="h1" id="headline">Headline</h1>
            <p class="sum" id="summary">Summary</p>
            <div class="meta">
              <div id="source">Source</div>
              <div id="relTime">just now</div>
            </div>
          </div>

          <div class="footer-bar">
            <button class="btn btn-primary" id="readMore">Read More&nbsp;‚Üó</button>
            <button class="fab" id="shareBtn">‚§¥</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Share Sheet -->
  <div class="sheet-backdrop" id="sheetBackdrop" role="dialog" aria-modal="true">
    <div class="sheet">
      <button class="x" id="sheetClose">‚úï</button>
      <h3>Share News</h3>
      <div class="share-row" id="shareWhatsApp">üü¢ WhatsApp</div>
      <div class="share-row" id="shareTelegram">‚úàÔ∏è Telegram</div>
      <div class="share-row" id="shareNative">üì§ System Share</div>
      <div class="share-row" id="shareCopy">üîó Copy Link</div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // Config / Helpers
    const FILES2_URL = "https://xjnwkwnznfnfmmmlqztf.supabase.co/storage/v1/object/public/news-cache/files2.json";
    const STORAGE_KEY = "newsly_feed";
    const breakKeywords = [
      "breaking","accident","crash","death","died","collapse","disaster","win","won","hurricane",
      "earthquake","explosion","blast","attack","flood","fire","shooting","emergency","strike","kill","injured",
      "alert","urgent","tragedy","rescue","wildfire","riot","violence","evacuate","storm","tsunami","victory","award",
    ];
    const chipCategories = ["Breaking News","General","Tech","Politics","Business","Sports","India","International"];

    const categoryMap = {
      "Tech":"technology",
      "International":"world",
      "Politics":"politics",
      "Business":"business",
      "Sports":"sports",
      "General":"general",
      "India":"india" // may not exist in feed; kept for parity
    };

    const placeholderDataUri = (() => {
      const svg = encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='800' height='500'>
        <defs><linearGradient id='g' x1='0' x2='1' y1='0' y2='1'><stop stop-color='#1f1f2b' offset='0'/><stop stop-color='#0f1020' offset='1'/></linearGradient></defs>
        <rect width='100%' height='100%' fill='url(#g)'/>
        <text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' fill='#717289' font-size='24' font-family='Arial, sans-serif'>No Image</text>
      </svg>`);
      return `data:image/svg+xml;charset=utf-8,${svg}`;
    })();

    const getSafe = (v, fb="Unknown") => (v && typeof v === "string" && v.trim()) ? v.trim() : fb;
    const limitSummary = (s="", n=50) => {
      const words = s.trim().split(/\s+/);
      return words.length <= n ? s : words.slice(0,n).join(" ") + "...";
    };
    const trimSource = (s="", max=20) => s.length>max ? s.slice(0,max-1)+"‚Ä¶" : s;
    const formatRelativeTime = (iso) => {
      if(!iso) return "";
      const now = new Date();
      const d = new Date(iso);
      const diff = now - d;
      if (isNaN(diff)) return "";
      const s = Math.floor(diff/1000);
      const m = Math.floor(s/60);
      const h = Math.floor(m/60);
      const days = Math.floor(h/24);
      if (s < 60) return "just now";
      if (m < 60) return `${m} minute${m!==1?"s":""} ago`;
      if (h < 24) return `${h} hour${h!==1?"s":""} ago`;
      if (days < 2) return "yesterday";
      return `${days} day${days!==1?"s":""} ago`;
    };
    const dedupArticles = (arr=[]) => {
      const seen = {};
      for (const a of arr){
        const k = a?.id || a?.url;
        if (k) seen[k] = a;
      }
      return Object.values(seen);
    };

    // State
    let allArticles = [];
    let filtered = [];
    let currentIndex = 0;
    let selectedType = "Breaking News";

    // DOM
    const chipsEl = document.getElementById("chips");
    const loaderEl = document.getElementById("loader");
    const emptyEl = document.getElementById("empty");
    const cardEl = document.getElementById("card");
    const imgEl = document.getElementById("artImg");
    const pillEl = document.getElementById("pill");
    const headlineEl = document.getElementById("headline");
    const summaryEl = document.getElementById("summary");
    const sourceEl = document.getElementById("source");
    const relTimeEl = document.getElementById("relTime");
    const readBtn = document.getElementById("readMore");
    const shareBtn = document.getElementById("shareBtn");
    const scrollBody = document.getElementById("scrollBody");
    const refreshBtn = document.getElementById("refreshBtn");

    const sheetBackdrop = document.getElementById("sheetBackdrop");
    const sheetClose = document.getElementById("sheetClose");
    const shareWhatsApp = document.getElementById("shareWhatsApp");
    const shareTelegram = document.getElementById("shareTelegram");
    const shareNative = document.getElementById("shareNative");
    const shareCopy = document.getElementById("shareCopy");
    const toastEl = document.getElementById("toast");

    function showToast(msg){
      toastEl.textContent = msg;
      toastEl.style.display = "block";
      setTimeout(()=>toastEl.style.display="none", 2200);
    }

    // Chips
    function renderChips(){
      chipsEl.innerHTML = "";
      chipCategories.forEach(cat=>{
        const b = document.createElement("button");
        b.className = "chip" + (selectedType===cat ? " active":"");
        b.textContent = cat;
        b.onclick = () => {
          selectedType = cat;
          document.querySelectorAll(".chip").forEach(c=>c.classList.remove("active"));
          b.classList.add("active");
          applyFilter();
          currentIndex = 0;
          renderCard();
          centerChip(b);
        };
        chipsEl.appendChild(b);
      });
      const active = Array.from(chipsEl.children).find(c=>c.classList.contains("active"));
      if (active) centerChip(active);
    }
    function centerChip(el){
      const parent = chipsEl;
      const rect = el.getBoundingClientRect();
      const pRect = parent.getBoundingClientRect();
      const offset = (rect.left + rect.width/2) - (pRect.left + pRect.width/2);
      parent.scrollBy({ left: offset, behavior:"smooth" });
    }

    // Fetch feed
    async function fetchFeed(showToastMsg=true){
      loaderEl.style.display = "grid";
      emptyEl.style.display = "none";
      cardEl.style.display = "none";
      try{
        const resp = await fetch(FILES2_URL, {cache:"no-store"});
        if (!resp.ok) throw new Error("Failed to load feed");
        const json = await resp.json();
        const articles = Array.isArray(json?.articles) ? json.articles : [];
        let news = dedupArticles(articles.filter(Boolean));
        news.sort((a,b)=>{
          const ta = a.time && !isNaN(Date.parse(a.time)) ? Date.parse(a.time) : 0;
          const tb = b.time && !isNaN(Date.parse(b.time)) ? Date.parse(b.time) : 0;
          return tb - ta;
        });
        localStorage.setItem(STORAGE_KEY, JSON.stringify(news));
        allArticles = news;
        if (showToastMsg) showToast("Refresh successful! New updates every ~3 hours.");
      }catch(e){
        // Fallback to cache if available
        const cached = localStorage.getItem(STORAGE_KEY);
        if (cached){
          allArticles = JSON.parse(cached);
          showToast("Loaded from cache.");
        }else{
          showToast("Sync failed.");
        }
      }finally{
        applyFilter();
        currentIndex = 0;
        loaderEl.style.display = "none";
        if (!filtered.length){
          emptyEl.style.display = "grid";
        }else{
          cardEl.style.display = "block";
          renderCard();
        }
      }
    }

    // Filter logic
    function applyFilter(){
      const usable = allArticles?.length ? allArticles : [];
      if (selectedType === "General"){
        filtered = usable.slice();
      } else if (selectedType === "Breaking News"){
        filtered = usable.filter(it=>{
          const hay = `${it?.headline||""} ${it?.summary||""} ${it?.category||""}`.toLowerCase();
          return breakKeywords.some(k => hay.includes(k));
        });
      } else {
        const key = (categoryMap[selectedType] || selectedType).toLowerCase();
        filtered = usable.filter(it => (it?.category||"").toLowerCase() === key);
      }
      if (!filtered.length && selectedType !== "General" && selectedType !== "Breaking News"){
        // Fallback: show all if filter is empty to keep UX smooth
        filtered = usable.slice();
      }
    }

    // Render
    function renderCard(){
      if (!filtered.length){
        emptyEl.style.display = "grid";
        cardEl.style.display = "none";
        return;
      }
      emptyEl.style.display = "none";
      cardEl.style.display = "block";

      const item = filtered[(currentIndex % filtered.length + filtered.length) % filtered.length];

      const imgSrc = (item?.image && item.image.trim()) ? item.image.trim() : placeholderDataUri;
      imgEl.src = imgSrc;
      imgEl.onerror = () => { imgEl.src = placeholderDataUri; };

      pillEl.textContent = getSafe(item?.category).toUpperCase();

      headlineEl.textContent = getSafe(item?.headline);
      summaryEl.textContent = limitSummary(getSafe(item?.summary,""), 50);
      sourceEl.textContent = trimSource(getSafe(item?.source,""));
      relTimeEl.textContent = item?.time ? formatRelativeTime(item.time) : "";

      readBtn.onclick = () => {
        if (item?.url){ window.open(item.url, "_blank","noopener,noreferrer"); }
      };

      shareBtn.onclick = () => openShare(item);

      // Preload neighbors
      const prev = filtered[(currentIndex - 1 + filtered.length) % filtered.length];
      const next = filtered[(currentIndex + 1) % filtered.length];
      [prev,next].forEach(n=>{
        if (n?.image){
          const im = new Image();
          im.src = n.image;
        }
      });

      // Reset scroll within the card body when changing item
      scrollBody.scrollTo({top:0, behavior:"instant"});
    }

    // Navigation
    function goNext(){
      if (!filtered.length) return;
      currentIndex = (currentIndex + 1) % filtered.length;
      animateSwipe(-1);
      renderCard();
    }
    function goPrev(){
      if (!filtered.length) return;
      currentIndex = (currentIndex - 1 + filtered.length) % filtered.length;
      animateSwipe(1);
      renderCard();
    }

    // Swipe handling (touch + mouse drag), wheel, keyboard
    let startY=null, startTime=0, dragging=false;
    function onDown(e){
      dragging = true; cardEl.classList.add("swiping");
      startY = (e.touches ? e.touches[0].clientY : e.clientY);
      startTime = performance.now();
    }
    function onMove(e){
      if (!dragging || startY==null) return;
      const y = (e.touches ? e.touches[0].clientY : e.clientY);
      const dy = y - startY;
      const abs = Math.abs(dy);
      const scale = Math.max(0.9, 1 - abs/1000);
      cardEl.style.transform = `translateY(${dy}px) scale(${scale})`;
    }
    function onUp(e){
      if (!dragging) return;
      dragging = false; cardEl.classList.remove("swiping");
      const endY = (e.changedTouches ? e.changedTouches[0].clientY : (e.clientY ?? startY));
      const dy = endY - startY;
      const dt = performance.now() - startTime;
      const velocity = dy / Math.max(dt,1); // px/ms
      const threshold = 90, vThresh = 0.6; // ~0.6 px/ms
      if (dy < -threshold || velocity < -vThresh){
        cardEl.style.transform = `translateY(-120vh) scale(0.85)`;
        setTimeout(()=>{ cardEl.style.transform = `translateY(0) scale(1)`; goNext(); }, 120);
      } else if (dy > threshold || velocity > vThresh){
        cardEl.style.transform = `translateY(120vh) scale(0.85)`;
        setTimeout(()=>{ cardEl.style.transform = `translateY(0) scale(1)`; goPrev(); }, 120);
      } else {
        cardEl.style.transform = `translateY(0) scale(1)`;
      }
      startY = null;
    }
    function animateSwipe(dir){
      // Optional micro-bounce to mimic transition after index changes
      cardEl.animate([
        { transform: `translateY(${dir*16}px) scale(0.99)` },
        { transform: `translateY(0) scale(1)` }
      ], { duration:160, easing:"ease-out" });
    }

    // Wheel (desktop) - small debounce window
    let wheelLock = false;
    window.addEventListener("wheel", (e)=>{
      if (wheelLock) return;
      const delta = e.deltaY;
      // If inner scrollable content can scroll, allow it first
      const atTop = scrollBody.scrollTop <= 0;
      const atBottom = Math.ceil(scrollBody.scrollTop + scrollBody.clientHeight) >= scrollBody.scrollHeight;

      if (delta > 0 && atBottom){
        wheelLock = true; goNext(); setTimeout(()=>wheelLock=false, 300);
      } else if (delta < 0 && atTop){
        wheelLock = true; goPrev(); setTimeout(()=>wheelLock=false, 300);
      }
    }, {passive:true});

    // Keyboard
    window.addEventListener("keydown", (e)=>{
      if (e.key === "ArrowDown" || e.key === "PageDown"){ e.preventDefault(); goNext(); }
      if (e.key === "ArrowUp" || e.key === "PageUp"){ e.preventDefault(); goPrev(); }
    });

    // Pointer / touch listeners on the card
    cardEl.addEventListener("mousedown", onDown);
    window.addEventListener("mousemove", onMove);
    window.addEventListener("mouseup", onUp);
    cardEl.addEventListener("touchstart", onDown, {passive:true});
    window.addEventListener("touchmove", onMove, {passive:true});
    window.addEventListener("touchend", onUp, {passive:true});
    window.addEventListener("touchcancel", onUp, {passive:true});

    // Share
    function openShare(item){
      sheetBackdrop.style.display = "flex";
      // Bind handlers
      const text = `${getSafe(item?.headline,"")}\n${item?.url||""}`.trim();
      shareWhatsApp.onclick = ()=>{
        const href = `https://wa.me/?text=${encodeURIComponent(text)}`;
        window.open(href, "_blank","noopener,noreferrer");
        closeSheet();
      };
      shareTelegram.onclick = ()=>{
        const href = `https://t.me/share/url?url=${encodeURIComponent(item?.url||"")}&text=${encodeURIComponent(getSafe(item?.headline,""))}`;
        window.open(href, "_blank","noopener,noreferrer");
        closeSheet();
      };
      shareNative.onclick = async ()=>{
        try{
          if (navigator.share){
            await navigator.share({ title:getSafe(item?.headline,"News"), text:getSafe(item?.headline,""), url:item?.url||location.href });
          }else{
            await navigator.clipboard.writeText(item?.url||"");
            showToast("Link copied to clipboard.");
          }
        }catch(_){}
        closeSheet();
      };
      shareCopy.onclick = async ()=>{
        await navigator.clipboard.writeText(item?.url||"");
        showToast("Link copied to clipboard.");
        closeSheet();
      };
    }
    function closeSheet(){ sheetBackdrop.style.display = "none"; }
    sheetBackdrop.addEventListener("click",(e)=>{ if (e.target===sheetBackdrop) closeSheet(); });
    sheetClose.addEventListener("click", closeSheet);

    // Refresh
    refreshBtn.addEventListener("click", ()=>fetchFeed(true));

    // Init
    (async function init(){
      renderChips();
      await fetchFeed(false);
    })();
  </script>
</body>
</html>
